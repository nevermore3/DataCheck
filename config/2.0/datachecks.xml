<?xml version="1.0" encoding="utf-8"?>
<datachecks>
  <datacheck TYPE="1" NAME="逻辑关系检查">
    <!--LEVEL: 0=ERROR, 1=WARNING, 2=INFO-->
    <datacheckitem ID="10001"
                   NAME="车道组未关联道路或关联道路无效"
                   LEVEL="0"
                   INFO="表hd_lane_group数据有确实或错误,车道组LaneGroup未关联道路Road或关联道路Road无效"
                   SQL="select id lanegroupid, road_id roadid from hd_lane_group where road_id=-1 or road_id not in(select id from road);"/>
    <datacheckitem ID="10002"
                   NAME="车道组有效性检查"
                   LEVEL="0"
                   INFO="表HD_LANE_GROUP中的车道组在表hd_r_lane_group中无法找到"
                   SQL="SELECT ID, ROAD_ID ROADID FROM HD_LANE_GROUP WHERE ID IN(SELECT ID FROM HD_LANE_GROUP EXCEPT SELECT LG_ID FROM HD_R_LANE_GROUP);"/>
    <datacheckitem ID="10003"
                   NAME="车道未关联车道组"
                   LEVEL="0"
                   INFO="表hd_r_lane_group数据有缺失,车道Lane未关联车道组LaneGroup"
                   SQL="select id laneid from hd_lane where id not in (select lane_id from hd_r_lane_group);"/>
    <datacheckitem ID="10004"
                   NAME="车道关联多个车道组"
                   LEVEL="0"
                   INFO="表hd_r_lane_group数据有错误,车道Lane关联多个车道组LaneGroup"
                   SQL="select lane_id laneid, group_concat(LG_ID) lanegroupids from hd_r_lane_group where lane_id in(select distinct lane_id laneid from hd_r_lane_group group by lane_id having count(*)>1) group by lane_id;"/>
    <datacheckitem ID="10005"
                   NAME="车道关联车道线无效"
                   LEVEL="0"
                   INFO="表hd_divider数据有缺失,车道Lane关联左右车道线Divider无效"
                   SQL="select id laneid, divider_l dividerid, 1 as isleft from hd_lane where divider_l not in (select id from hd_divider) union select id, divider_r, 0 from hd_lane where divider_r not in (select id from hd_divider);"/>
    <datacheckitem ID="10006"
                   NAME="车道线关联节点无效"
                   LEVEL="0"
                   INFO="表HD_DIVIDERNODE数据有缺失,车道线Divider关联的节点DividerNode编号在HD_DIVIDERNODE表无法找到"
                   SQL="select * from (SELECT distinct fdnode nodeid FROM HD_DIVIDER union select distinct tdnode from hd_divider) where nodeid not in(select id from hd_divider_node);"/>
    <datacheckitem ID="10007"
                   NAME="两个车道关联的左右车道线完全一致"
                   LEVEL="1"
                   INFO="表HD_LANE数据错误,非出入口两条车道Lane关联的左右车道线Divider完全相同"
                   SQL="SELECT L.* FROM (select a.id firstLaneId, b.id secLaneId from hd_lane a join hd_lane b on a.id&lt;&gt;b.id and ((a.divider_l=b.divider_l and a.divider_r=b.divider_r) or (a.divider_l=b.divider_r and a.divider_r=b.divider_l))) L 
                   JOIN HD_LANE_GEOTOPO A ON L.firstLaneId=A.FID JOIN HD_LANE_GEOTOPO B ON L.secLaneId=B.FID AND NOT (A.SGEONODEID=B.SGEONODEID OR A.SGEONODEID=B.EGEONODEID OR A.EGEONODEID=B.EGEONODEID OR A.EGEONODEID=B.SGEONODEID);"/>
    <datacheckitem ID="10008"
                   NAME="车道孤立不连通"
                   LEVEL="1"
                   INFO="表hd_lane_connectivity数据有丢失,车道Lane是孤立存在,车道连通性存在错误"
                   SQL="select id laneid from hd_lane where id not in (select distinct flane_id from hd_lane_connectivity group by flane_id union select distinct tlane_id from hd_lane_connectivity group by tlane_id);"/>
    <datacheckitem ID="10009"
                   NAME="车道形态连通的关系丢失"
                   LEVEL="0"
                   INFO="拓扑形态连接的两条Lane在HD_LANE_CONNECTIVITY中不存在导致拓扑关系丢失"
                   SQL="SELECT FLANE_ID,TLANE_ID FROM HD_LANE_GEOCONN EXCEPT SELECT FLID, TLID FROM (SELECT FLANE_ID FLID,TLANE_ID TLID FROM HD_LANE_CONNECTIVITY UNION SELECT TLANE_ID,FLANE_ID FROM HD_LANE_CONNECTIVITY);"/>
    <datacheckitem ID="10010"
                   NAME="车道拓扑关系无效"
                   LEVEL="0"
                   INFO="HD_LANE_CONNECTIVITY中存在拓扑关系的两条Lane在形态上不连通,如果连接点XY相等需确认Z值是否相等"
                   SQL="SELECT FLANE_ID,TLANE_ID FROM HD_LANE_CONNECTIVITY EXCEPT SELECT FLID, TLID FROM (SELECT FLANE_ID FLID, TLANE_ID TLID FROM HD_LANE_GEOCONN UNION SELECT TLANE_ID, FLANE_ID FROM HD_LANE_GEOCONN);"/>
    <datacheckitem ID="10011"
                   NAME="车道线冗余错误"
                   LEVEL="0"
                   INFO="表hd_divider数据冗余,存在多条车道线Divider几何形态完全一致的情况"
                   SQL="SELECT REPEATID, ID DIVIDERID FROM HD_DIVIDER D JOIN (SELECT DISTINCT geometry, MIN(ROWID) REPEATID FROM HD_DIVIDER GROUP BY geometry HAVING COUNT(*)&gt;1) G ON D.GEOMETRY=G.GEOMETRY;"/>
    <datacheckitem ID="10012"
                   NAME="车道冗余错误"
                   LEVEL="0"
                   INFO="表hd_lane数据冗余,存在多条车道Lane几何形态完全一致的情况"
                   SQL="SELECT REPEATID, ID LANEID FROM HD_LANE D JOIN (SELECT DISTINCT geometry, MIN(ROWID) REPEATID FROM HD_LANE GROUP BY geometry HAVING COUNT(*)&gt;1) G ON D.GEOMETRY=G.GEOMETRY AND REPEATID!=ID;"/>
    <datacheckitem ID="10013"
                   NAME="Lane或Dividerf分组形态错误"
                   LEVEL="0"
                   INFO="Lane或Divider几何首尾点完全相同，导致NDS编译无法建立LaneConnectorId拓扑"
                   SQL="SELECT FileName fileName, FileName||'_GEOCOORDS' tblName FROM ARCSHAPE_METADATA WHERE SHPType=13 AND (FileName LIKE '%lane%' OR FileName LIKE '%divider%') COLLATE NOCASE;
                   SELECT DISTINCT '{fileName}' FILENAME, group_concat(FID) FEATUREIDS FROM 
                   (SELECT se.FID, s.x sx, s.y sy, s.z sz, e.x ex, e.y ey, e.z ez FROM 
                   (SELECT FID, MIN(indexpoint) sptid, MAX(indexpoint) eptid FROM {tblName} GROUP BY FID) se 
                   LEFT JOIN {tblName} s ON se.FID=s.FID AND se.sptid=s.indexpoint 
                   LEFT JOIN {tblName} e ON se.FID=e.FID AND se.eptid=e.indexpoint) GROUP BY sx,sy,sz,ex,ey,ez HAVING COUNT(*)&gt;1;"/>
    <datacheckitem ID="10014"
                   NAME="车道LaneType检查"
                   LEVEL="0"
                   INFO="HD_LANE_ATTRIBUTE表存在一条Lane有多个LANETYPE的情况"
                   SQL="SELECT DISTINCT LANE_ID FROM (SELECT DISTINCT lane_id, lanetype FROM HD_LANE_ATTRIBUTE GROUP BY lane_id, lanetype HAVING count(*)&gt;1) GROUP BY lane_id HAVING count(*)&gt;1;"/>
    <datacheckitem ID="10015"
                   NAME="车道编号检查"
                   LEVEL="0"
                   INFO="HD_LANE表中存在无效车道号Lane_No不在(0~16)范围"
                   SQL="SELECT ID, Lane_no LaneNO FROM HD_LANE where lane_no&gt;16 or lane_no&lt;0;"/>
    <datacheckitem ID="10016"
                   NAME="DIVIDER对应DA属性检查"
                   LEVEL="0"
                   INFO="DIVIDER的DA属性错误：无DA,首点无DA,SPIDX超限"
                   SQL="SELECT ID, NULL SPIDX, 'Divider无DA' INFO FROM(SELECT ID FROM HD_DIVIDER EXCEPT SELECT DIVIDER_ID FROM HD_DIVIDER_ATTRIBUTE) 
                   UNION SELECT DIVIDER_ID, MIN(SPIDX), 'Divider首点无DA' FROM HD_DIVIDER_ATTRIBUTE GROUP BY DIVIDER_ID HAVING MIN(SPIDX)&gt;0 
                   UNION SELECT DIVIDERID, SPIDX, 'DA SPIDX值超限' FROM (SELECT DIVIDER_ID DIVIDERID, SPIDX FROM HD_DIVIDER_ATTRIBUTE WHERE SPIDX&lt;0 
                     UNION SELECT DIVIDER_ID, SPIDX FROM HD_DIVIDER_ATTRIBUTE DA JOIN (SELECT FID, MAX(INDEXPOINT) NUMPT FROM HD_DIVIDER_GEOCOORDS GROUP BY FID) DN ON DA.DIVIDER_ID=DN.FID AND DA.SPIDX>NUMPT) 
                     UNION SELECT DIVIDER_ID,SPIDX, '单个DividerNode上有多个DA' FROM HD_DIVIDER_ATTRIBUTE GROUP BY DIVIDER_ID,SPIDX HAVING COUNT(*)&gt;1 ORDER BY INFO;"/>
    <datacheckitem ID="10017"
                   NAME="对象ID记录重复性检查"
                   LEVEL="1"
                   INFO="数据中存在ID相同的重复记录"
                   SQL="SELECT fileName tblName FROM ARCSHAPE_METADATA WHERE SHPType&lt;&gt;0; select '{tblName}' FileName, id RepeatId, count(*) RecoordCount from {tblName} group by id having count(*)>1;"/>

    <datacheckitem ID="20001"
                   NAME="几何数据重复性检查"
                   LEVEL="0"
                   INFO="数据中存在几何对象完全相同的重复记录"
                   SQL="SELECT fileName tblName FROM ARCSHAPE_METADATA WHERE SHPType&lt;&gt;0; 
                   SELECT rp.FileName, RepeatGeometryIds, T.TASKID, LocalX, LocalY FROM (SELECT '{tblName}' FileName, min(r.id) localid, group_concat(id) RepeatGeometryIds FROM {tblName} r 
                   JOIN (SELECT DISTINCT geometry FROM {tblName} GROUP BY geometry HAVING count(*)>1) g ON r.geometry=g.geometry GROUP BY r.geometry) rp 
                   JOIN (SELECT min(FID) minid, X LocalX, Y LocalY FROM {tblName}_GEOCOORDS GROUP BY FID) b ON b.minid=rp.localid 
                   LEFT JOIN HD_AUX_TASKID T ON T.ID=B.MINID AND T.FILENAME='{tblName}' COLLATE NOCASE;"/>
    <datacheckitem ID="20002"
                   NAME="多边形形态错误"
                   LEVEL="0"
                   INFO="多边形对象至少要包含4个点,且首尾点坐标相等构成闭合环"
                   SQL="SELECT FileName||'_GEOCOORDS' tblName FROM ARCSHAPE_METADATA WHERE SHPType=15;SELECT '{tblName}' TBLNAME, FID, COUNT(*) NUMPOINTS FROM {tblName} GROUP BY FID HAVING NUMPOINTS&lt;4;"/>
    <datacheckitem ID="20003"
                   NAME="几何数据坐标值异常检查"
                   LEVEL="0"
                   INFO="几何数据中存在坐标值X(0~360) 或 坐标值Y(-90~90) 或坐标值Z(马里亚纳海沟-11034m~珠穆朗玛峰8848m)异常的情况"
                   SQL="SELECT FileName fileName, FileName||'_GEOCOORDS' tblName FROM ARCSHAPE_METADATA WHERE SHPType&lt;&gt;0;SELECT '{fileName}' FILENAME, FID, INDEXPOINT, X, Y, Z FROM {tblName} WHERE (X&gt;360 OR X&lt;0) OR (Y&gt;90 OR Y&lt;-90) OR (Z&gt;8848 OR Z&lt;-11034);"/>
    <!--<datacheckitem ID="13"
                   NAME="车道拓扑关系缺失"
                   LEVEL="0"
                   INFO="表hd_lane_connectivity数据有丢失,相邻车道连接拓扑关系丢失"
                   SQL="SELECT NODE_ID, FLANE_ID, TLANE_ID FROM TMP_LANE_CONN EXCEPT SELECT NODE_ID, FLANE_ID, TLANE_ID FROM (SELECT DISTINCT LC.* FROM TMP_LANE_CONN LC JOIN HD_LANE_CONNECTIVITY CT ON CT.FLANE_ID=LC.FLANE_ID AND CT.TLANE_ID=LC.TLANE_ID UNION ALL SELECT DISTINCT LC.* FROM TMP_LANE_CONN LC JOIN HD_LANE_CONNECTIVITY CT ON CT.FLANE_ID=LC.TLANE_ID AND CT.TLANE_ID=LC.FLANE_ID);"/>-->  
  </datacheck>
</datachecks>
